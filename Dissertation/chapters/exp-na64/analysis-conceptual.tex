\section{Анализ данных}

Весьма важен вопрос анализа данных,
как процедуры обработки экспериментальных данных
направленной на проверку определённых статистических гипотез.
%В самом деле, процедуры сложно разделить
%практически, поскольку алгоритмы реконструкции содержат
%различные подстроечные параметры выбираемые из статистических
%соображений, с учётом физического процесса лежащего в основе
%конкретного измерительного процесса.

Сложившаяся практика работы с экспериментальными
данными обычно подразумевает разделение фаз отладки процедур
физической реконструкции событий и физического анализа данных.
У этого разделения есть как технические, так и методические причины.

К техническим относятся, например, многоэтапность процедуры
реконструкции, часто включающая применение итеративных операций,
использование алгоритмов с обратной связью. Кроме того,
%как уже отмечалось,
реконструкция в современном физическом эксперименте
как правило, представляет собой чрезвычайно требовательную задачу
к вычислительным ресурсам. По этой причине результат
реконструкции обычно сохраняется в виде промежуточных данных,
удобных для последующего анализа.

К методическим относится, например,
стратегии <<слепого анализа>>~\cite{blind-analysis} (анализа по слепому методу)
предписывающая экспериментатору исключать из рассмотрения
параметрические области, в которых может присутствовать исследуемый
сигнал до тех пор, пока все алгоритмы реконструкции и критерии отбора,
а также все процедуры анализа не окажутся
зафиксированы, и все проверки независимых данных, систематических
ошибок и методы статистической интерпретации результата не будут
выполнены.

Поскольку NA64 направлен прежде всего на поиск гипотетических частиц,
основная задача анализа сводится в вероятностном
смысле к проверке гипотезы $H_0$ о средней частоте событий с
заданным уровнем \emph{статистической значимости}~$\alpha$
(вероятность ложноположительного заключения).
В экспериментальной физике высоких энергий открытием считается
гипотеза подтверждённая на уровне статистической значимости
соответствующей $5\sigma$-квантилю нормального распределения,
что соответствует вероятности ложноположительного (ошибка первого рода)
результата~$\alpha =\text{erfc}(5\sigma) =2{,}866\cdot10^{-7}$.
%(вычисляемого как односторонний критерий нормального распределения).

В случае когда статистика сигнальных событий невелика, необходимо
учитывать эффекты связанные с дискретностью отдельных
событий (процесс Пуассона).

\begin{comment}
В частности, \eqref{eq:cls-definition} значит, что даже
в случае отсутствия ожидаемых фоновых событий в сигнальной
области~($\nu_b = 0$),
%$H_0$ на заданном уровне значимости принимается <<с допуском>>:
любая гипотеза предсказывающая число событий меньшее
$- \text{ln} ~\alpha$ будет отвергнута. Для некоторых
значений $\alpha$ минимальное
число событий приведено в таблице~\ref{tab:cls-alpha-examples}.
\begin{table}[ht]
    \centering
    \begin{tabular}{r|c}
        $\alpha$ & $s$ \\ \hline
        $0{,}1$ & $2{,}3$ \\
        $0{,}01$ & $4{,}6$ \\
        $1-\text{erfc}(5\sigma)$ & $15{,}0$
    \end{tabular}
    \caption{Минимальное число событий для различных $\alpha$}
    \label{tab:cls-alpha-examples}
\end{table}
\end{comment}

Допустим, нулевая гипотеза ($H_0$) состоит в том,
что частота событий равна $\nu_b$, а альтернативная
гипотеза $H_1$ заключается в том что $\nu > n_b$
(тест на избыточность).
Тогда в качестве критерия следует взять вероятность получить
такое же или большее число событий по сравнению с
наблюдаемым~$N$, для ожидаемого среднего~$\nu_b$:
%(односторонний доверительный интервал распределения Пуассона)
\begin{equation}
    P(n \ge N|\nu_b) = \sum\limits_{k=N}^{\infty} \frac{\nu_b^n e^{-\nu_b}}{n!}.
    \label{eq:poisson-no-bg}
\end{equation}

%Выражение \eqref{eq:poisson-no-bg} отвечает на вопрос <<какова вероятность
%получить число событий равное или большее $N$ при известной средней
%частоте $\nu_b$?>>. 
Если эта вероятность оказывается меньше заданного
уровня значимости $P(n \ge N|\nu_b) < \alpha$, гипотеза $H_0$ отвергается,
что можно качественно интерпретировать как то, что событий оказалось
<<слишком много>>, чтобы их можно было достоверно объяснить
только фоновыми событиями.

% Ошибка 1-ого рода: отвергнуть правильн. (её вер-ть -- alpha, "уровень значимости")
% Ошибка 2-ого рода: принять неправильн. (её вер-ть -- beta, "1-мощность")
%
%  решение \ истин. | true     | false
% ------------------+----------+--------
%   posit. (reject) | 1-\beta  | \alpha (1st err)
%   negat. (accept) | 1-\alpha | \beta (2nd err)
%

При этом ошибку второго рода -- %(принятие неправильной гипотезы)
неверное объяснение наблюдаемых событий фоновыми явлениями,
нужно рассматривать с учётом предположения о частоте
сигнала~$\nu_s$. Мощность критерия связана с вероятностью ошибки
второго рода $\beta(\nu_s)$ следующим образом:
\begin{equation}
    P(n \ge N|\nu_b + \nu_s)
        = 1 - \beta(\nu_s) = e^{-(\nu_b + \nu_s)} \sum\limits_{n=N}^{\infty} \frac{(\nu_b + \nu_s)^n}{n!}.
\end{equation}
тогда сравнение с уровнем статистической значимости 
будет ошибочно принимать $H_0$ для всех $\nu_s$ в случае
когда $P(n \ge N|\nu_b + \nu_s)\ge\alpha$. Таким образом, даже
в случае, когда фоновые события не ожидаются ($\nu_b = 0$),
и событий в эксперименте не наблюдалось вовсе ($N=0$),
любая гипотеза предсказывающая частоту $\nu_s > -\text{ln}(\alpha)$
будет отвергнута. Этот на первый взгляд тривиальный результат
существенно важен для
выводов о чувствительности эксперимента, поскольку позволяет
в определённом доверительном пределе (англ. \emph{confidence limit},
$\text{CL}_{s+b} = P(n \ge N|\nu_b + \nu_s)$)
исключить область параметрического пространства на основе
набранной статистики. Таблица \ref{tab:cls-alpha-examples}
содержит значения $\nu_s$ для некоторых доверительных пределов часто
используемых в литературе.

\begin{table}[ht]
    \centering
    \begin{tabular}{r|c}
        $\text{CL}_{s+b} = 1 - \alpha$ & $\nu_s$ \\ \hline
        $0{,}9$ & $2{,}3$ \\
        $0{,}99$ & $4{,}6$ \\
        <<$5 \sigma$>>, $ 1 - \Phi(5)$ & $15{,}0$
    \end{tabular}
    \caption{Максимальное число событий принятия $H_0$ для
    различных значений доверительного предела при отсутствии
    фона}
    \label{tab:cls-alpha-examples}
\end{table}

В формулировке условной вероятности,
%\footnote{Условная вероятность $P(A|B) = P(A \cap B) / P(B)$.}
%включающей предположение о частоте сигнала $\nu_s$.
вероятность $\epsilon$ наблюдать $N$ или менее событий из
которых $N$ или менее событий составляют фоновые, при уровне
сигнала~$\nu_s$~\cite{cls-mtd-zech}:
\begin{equation}
    \epsilon =P(n \le N | n_b \le N, \nu_s + \nu_b) = \frac{P(n \le N | \nu_s +\nu_b)}{P(n_b \le N | \nu_b)}.
    \label{eq:cls-cond-prob}
\end{equation}

Следует заметить, что формулу~\eqref{eq:cls-cond-prob} можно
интерпретировать по-разному. Полученная первоначально из
байесовского подхода, она получила применение в
экспериментальной физики частиц и в рамках частотной
интерпретации, обобщённая в
т.н. $\text{CL}_s$-метод~\cite{cls-harel, read-cls} --- консервативный
способ установить верхний предел на сигнал в условиях малой
чувствительности эксперимента. Общая идея метода состоит в
определения отношения вероятностей под гипотезами <<сигнал+фон>>
и <<только фон>>, как записано в~\eqref{eq:cls-cond-prob},
однако направление интегрирования (для счётных статистик -- суммирования)
обычно обращают. Вводя параметр $\mu$ как величину определяющую вклад сигнала
(англ. \emph{signal strength}) в полную частоту
событий $\mu \nu_s + \nu_b$, записывают:
\begin{equation}
    \text{CL}_s (\mu) = \frac{\text{CL}_{s+b}}{1 - \text{CL}_b} = \frac{P(n \ge N | \mu\nu_s + \nu_b)}{P(n \ge N | \nu_b)}.
    \label{eq:cls-definition}
\end{equation}

%Для правильного понимания формулы \eqref{eq:cls-definition} важно
%иметь в виду, что $\text{CL}_x$ -- символическая запись,
%и $CL_{x} \ne P(x)$. В частности, $\text{CL}_s$ вообще не имеет
%вероятностного смысла.

Вклад сигнала $\mu$ считается исключённым со статистической
значимостью $\alpha$ в критической области $\text{CL}_s(\mu) < \alpha$.

%Важно отметить, что принятие гипотезы $H_0$ (отсутствие сигнала)
%на заданном уровне статистической значимости, не исключает
%гипотезу $H_1$. Принятие $H_0$ значит, что чувствительности
%эксперимента оказалось недостаточно для того, чтобы обнаружить
%статистически-значимый сигнал. По этой причине в поисковых
%исследованиях большое значение имеет указание параметрической
%области (и соответствующего порога статистической значимости)
%в которой сигнал не был обнаружен.

%We define CLs+b the "confidence level" as the probability to
%observe a number of events
%larger than the one observed in the experiment

%\begin{equation}
%    \text{CL}_{s+b}
%        = e^{-(\nu_s + \nu_b)}\sum\limits_{n=0}^N
%          \frac{(\nu_s + \nu_b)^n}{n!}
%\end{equation}

%Следует заметить, что такое упрощённое рассмотрение пренебрегает
%ошибкой при определении частоты фоновых событий и не учитывает
%влияние систематических ошибок.
%Современный статистический аппарат
С целью учёта систематических ошибок этот подход развивают,
в рамках односторонней статистики функций
правдоподобия $L(\mu, \theta)$ с \emph{мешающими параметрами} $\theta$,
%где $\mu$ регулирует вклад сигнала в частоту наблюдаемых
%событий $\mu \cdot \nu_s +\nu_b$
обобщая $\text{CL}_s$, и рассматривая теперь вместо статистики счёта
пуассоновских процессов статистику
профильного отношения
правдоподобия $q_\mu$~\cite{bityukov-krasnikov, read-cls, cls-harel}.
%Пусть регистрируемое число событий $\mu \cdot \nu_s + \nu_b$, где
%$\mu \in [0,1]$. Тогда функция правдоподобия записывается
% как вероятность одновременна вероятность иметь ... отнесённая к ...
\begin{equation}
    q_{\mu} = -2 ~\text{ln} \frac{L(\mu,\hat{\hat{\theta}})}{L(\hat{\mu}, \hat{\theta})}.
    \label{eq:qm-stat}
\end{equation}
Тогда ограничение на $\mu$ выводится из условия $\text{CL}_s (\mu) < \alpha$, где:
\begin{equation}
    \text{CL}_s = \frac{P_{s+b} (q_\mu \ge q^{obs}_{\mu})}{P_{b} (q_\mu \ge q^{obs}_{\mu})}
\end{equation}

Практически, рассматривая пространство из $m$ измеряемых величин,
часто используют гистограмму в качестве основной структуры данных
представляющих результаты измерения. В этом случае, функция
правдоподобия определяется как частотная вероятность в каждом
счётчике $j$ гистограммы:
\begin{equation}
    L(\mu,\theta) =\prod\limits_{j} \frac{\mu s_j + b_j}{n_j!}
        \prod\limits_{l} \prod\limits_{k} \frac{u_k^{m_k} (\theta_l)}{m_k!} e^{-u_k (\theta)}.
\end{equation}
%Если  $$ Функции правдоподобия $L(\mu, \theta)$ определяются 

Максимизация \eqref{eq:qm-stat} в малой окрестности $\theta_l$ позволяет
оценивать верхнюю границу доверительного интервала.

Метод $\text{CL}_s$ широко применяется в экспериментальной физике
высоких энергий для получения эффективного верхнего предела на сигнал,
с учётом перенормировки статистической значимости на фоновые события
и эффективность детектирующей аппаратуры.


\begin{comment}
%  решение \ истин. | true     | false
% ------------------+----------+--------
%   posit. (reject) | 1-\beta  | \alpha (1st err)
%   negat. (accept) | 1-\alpha | \beta (2nd err)
\begin{table}[ht]
    \centering
    \begin{tabular}{r|cc}
  Решение теста & $H_0$ верна     & $H_0$ не верна \\ \hline
   posit. (reject $H_0$) & FP, I-ого рода $P=\alpha$ & TP, $P=1-\beta$ \\
   negat. (accept $H_0$) & TN, $P=1-\alpha$ & FN, $P=\beta$ (II-ого рода) \\
    \end{tabular}
    \caption{Соответствие терминов ($\alpha$ -- стат. значимость, иначе <<доля FP среди случаев когда $H_0$ верна>>, вероятность отвергнуть правильную гипотезу;
    $\beta$ -- мощность критерия, вероятность того что нулевая гипотеза отвергнута, если верна конкурирующая)}
    \label{tab:placeholder}
\end{table}

В случае присутствия фонового вклада
часто прибегают к методу $CL_s$~\cite{cls-mtd-zech, read-cls}
представляющий собой консервативный способ выставления
верхних ограничений на сигнал.

Вероятность процесса Пуассона со средней частотой
$\nu_s + \nu_b$ даётся произведением вероятностей двух независимых
процессов в сумме дающих все возможные комбинации $n = n_s +n_b$:
\begin{equation}
    p(n;\nu_s+\nu_b)
      = \sum\limits_{n_b=0}^{n} \sum\limits_{n_s = 0}^{n-n_b}
            p(n_b;\nu_b) \cdot p(n_s;\nu_s)
      = \frac{1}{n!} (\nu_s+\nu_b)^n e^{-(\nu_s+\nu_b)}.
    \label{eq:frequentist-sb}
\end{equation}

Это выражение непригодно для непосредственных вычислений с
малыми~$n$, поскольку может приводить к отрицательным
значениям~$P$ в силу дискретности распределения
Пуассона~(в случае когда $b$ достаточно велико).
Последнее обстоятельство нужно учесть в первой
сумме~\ref{eq:frequentist-sb} имея в виду, что $n_b \ge N$.

Тогда вероятность $\epsilon$ наблюдать $N$ или менее
событий из которых $N$ или менее событий составляют фоновые,
при уровне сигнала~$\nu_s$:
\begin{equation}
    \epsilon
    = \frac{\sum\limits_{n=0}^N p(n;\nu_s+\nu_b)}{\sum\limits_{n_b=0}^N p(n_b;\nu_b)}.
    \label{eq:zach-prob}
\end{equation}

Выражение \eqref{eq:zach-prob} имеет смысл условной вероятности.
В общем случае, справедливо, что
\begin{equation}
    P(n \le N | n_b \le N, \nu_s + \nu_b) = \frac{P(n \le N | \nu_s +\nu_b)}{P(n_b \le N | \nu_b)}.
    \label{eq:cls-cond-prob}
\end{equation}

Это выражение можно использовать для вычисления доверительного
интервала в ситуациях анализа параметрических областей с фоном.
В литературе часто встречается альтернативная запись~\cite{cls-harel}:
\begin{equation}
    CL_s = \frac{p_{s+b}}{1 - p_b}
         = \frac{P(n \ge N | \nu_s + \nu_b)}{1 - P(n \ge N | \nu_b)},
\end{equation}
главное отличие которой от \eqref{eq:zach-prob} заключается
в направлении интегрирования (формулы эквивалентны).

Важно отметить, что принятие гипотезы $H_0$ (отсутствие сигнала)
на неком уровне статистической значимости, не исключает
гипотезу $H_1$. Принятие $H_0$ значит, что чувствительности
эксперимента оказалось недостаточно для того, чтобы обнаружить
статистически-значимый сигнал. По этой причине в поисковых
исследованиях большое значение имеет указание параметрической
области (и соответствующего порога статистической значимости)
в которой сигнал не был обнаружен.

Например, подстановка закона Пуассона в \eqref{eq:cls-cond-prob}
даёт $CL_s = e^{-\nu_s}$, что значит, что в случае
отсутствия событий в сигнальной области при известном (любом)
уровне фона, $H_0$ на заданном уровне значимости принимается
<<с допуском>>: любому заданному $\alpha$
отвечает максимальное число событий $- \text{ln} ~\alpha$ для которых
принята гипотеза $H_0$.
\begin{table}[ht]
    \centering
    \begin{tabular}{r|c}
        $\alpha$ & $s$ \\ \hline
        $0{,}9$ & $2{,}3$ \\
        $0{,}99$ & $4{,}6$ \\
        $\text{erfc}(5\sigma)$ & $15{,}0$
    \end{tabular}
    \caption{Значения $CL_s$ для различных $\alpha$}
    \label{tab:cls-alpha-examples}
\end{table}
Иными словами, на уровне значимости $\alpha$ гипотеза об отсутствии
сигнала не будет принята до тех пор, пока превышение сигнала над
уровнем фона не превосходит~$s$.

Более полное рассмотрение должно учитывать тот факт, что ожидаемый
фон в сигнальной области неоднороден. Как правило, случайная величина
характеризующая исследуемый феномен, заполняет гистограмму.

% ---

В этом случае рассматриваются
доверительные интервалы ($CL$) гипотезы о
частоте <<сигнал + фон>>~($CL_{s+b}$) и гипотезы о частоте
<<только фон>>~($CL_b$). Тогда консервативный критерий на
доверительный интервал гипотезы о сигнале при
заданном~$\alpha$ состоит в том что в параметрическом
пространстве сигнала должно выполнятся соотношение:
\begin{equation}
    CL_s = \frac{CL_{s+b}}{CL_b} < 1 - \alpha.
    \label{eq:cls-common}
\end{equation}

Необходимо заметить, что в то время как $CL_{s+b}$ и $CL_b$
являются интегралом функции плотности вероятности
(для распределения Пуассона -- отвечают $p$ в~\ref{eq:poisson-no-bg}),
запись $CL_s$ символическая, и имеет вероятностного смысла~\cite{cls-harel}.
Хотя подход исходит из частотной интерпретации вероятностей, стремясь
извлечь консервативную оценку для двух конкурирующих гипотез,
сам подход не является в полной мере ни частотным (поскольку рассматривает
ложноположительный исход), ни байесовским (поскольку не прибегает
к апостериорной оценке).

Удобно записать условие~\ref{eq:cls-common} в обозначениях условных
вероятностей:
\begin{equation}
    CL_s = \frac{P(q \ge q_{obs} | s+b)}{1 - P(q \ge q_{obs} | b)} \ge \alpha,
\end{equation}
где
\begin{itemize}
    \item $P(q \ge q_{obs}|s+b)$ -- вероятность получить такие же, или более
    экстремальные значения при условии <<сигнал+фон>>,
    \item $P(q \ge q_{obs} | b)$  -- вероятность получить такие же, или более
    экстремальные значения при условии <<только фон>>.
\end{itemize}
\end{comment}
